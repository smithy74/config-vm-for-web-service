# Настройка ВМ(Ubuntu 22.04) для проекта на Django с использованием Postgres, Nginx и Gunicorn

## Оглавление

1. [TimeWeb](#TimeWeb) \

   1.1. [Регистрация](#регистрация) \

   1.2. [Выбор сервера](#выбор-сервера) \

   1.3. [Покупка](#покупка)
2. [Подключение к серверу](#подключение-к-серверу) \

   2.1. [Создание ssh-ключа](#настройка-ssh) \

   2.2. [SSH подключение](#ssh-подключение) \

   2.3. [Подключение по SSH через Visual Studio Code](#работа-с-сервером-через-VSC)
3. [Настройка сервера](#настройка-сервера) \

   3.1. [Вход в систему от имени пользователя root](#вход-по-root)
   3.2. [Создание нового пользователя](#new_user)
   3.3. [Предоставление административных прав](#выдача-прав)
   3.4. [Настройка базового брандмауэра](#настройка-брандмауэра)
   3.5. [Включение внешнего доступа для вашего обычного пользователя](#включение-внешнего-доступа)

<h2 id="TimeWeb">TimeWeb</h2>

<h3 id="регистрация">Регистрация</h3>
<h3 id="выбор-сервера">Выбор сервера</h3>
<h3 id="покупка">Покупка</h3>

<h2 id="подключение-к-серверу">Подключение к серверу</h2>

<h3 id="настройка-ssh">2.1 Создание ssh-ключа</h3>

Как создать SSH-ключи
В Linux/macOS или Windows 10/11
Запустите терминал в Linux/macOS, либо утилиту cmd.exe или powershell.exe в Windows 10/11 и создайте пару ключей с помощью команды ssh-keygen:

```
 ssh-keygen -t ed25519
```

После выполнения команды укажите имена файлов, куда сохранятся ключи, и введите пароль для закрытого ключа. По умолчанию используется имя id_ed25519, ключи создаются в папке ~/.ssh текущего пользователя.
 Открытый ключ сохранится в файле <имя_ключа>.pub. Содержимое этого файла вставляется в поле SSH-ключ на странице создания ВМ.
В Windows 7/8
Если на вашем компьютере установлена Windows 7 или 8, то создать SSH-ключи можно с помощью приложения PuTTY. Как это сделать, рассказывается в документации.

<h3 id="ssh-подключение">2.2 SSH подключение</h3>

Чтобы подключиться к запущенной ВМ (статус RUNNING) по протоколу SSH, используют утилиту ssh в Linux/macOS или Windows 10/11, программу PuTTY в Windows 7/8 или любой другой клиент SSH.

Подключение по SSH в Linux/macOS или Windows 10/11
Откройте терминал в Linux/macOS или запустите PowerShell в Windows 10/11 и выполните команду:

```
ssh <имя_пользователя>@<публичный_IP-адрес_ВМ>
```

Если у вас несколько закрытых ключей, укажите нужный:

```
ssh -i <путь_к_ключу/имя_файла_ключа> <имя_пользователя>@<публичный_IP-адрес_ВМ>
```

При первом подключении может появиться предупреждение о неизвестном хосте:

```
The authenticity of host '130.193.40.101 (130.193.40.101)' can't be established.
ECDSA key fingerprint is SHA256:PoaSwqxRc8g6iOXtiH7ayGHpSN0MXwUfWHkGgpLELJ8.
Are you sure you want to continue connecting (yes/no)? 
```

Введите в терминале yes, нажмите Enter и вы окажетесь в консоли созданной ВМ.
image
Установите обновления. Для этого запустите в консоли команды:

```
sudo apt-get update
```

```
sudo apt-get upgrade 
```

<h3 id="работа-с-сервером-через-VSC">Работа с сервером через Visual Studio Code</h3>

<h2 id="настройка-сервера">Настройка сервера</h2>

<h3 id="вход-по-root">3.1 Вход в систему от имени пользователя root</h3>

Для входа на свой сервер вам необходимо знать общедоступный IP-адрес вашего сервера. Вам также понадобится пароль или — если вы установили SSH—ключ для аутентификации - закрытый ключ для учетной записи пользователя root. Если вы еще не вошли на свой сервер, вы можете захотеть следовать нашему руководству о том, как подключиться к Droplets с помощью SSH, в котором подробно описывается этот процесс.

Если вы еще не подключены к своему серверу, войдите в систему как пользователь root, используя следующую команду (замените выделенную часть команды общедоступным IP-адресом вашего сервера):

```
ssh root@your_server_ip
```

Примите предупреждение о подлинности хоста, если оно появится. Если вы используете аутентификацию по паролю, укажите свой пароль root для входа. Если вы используете SSH-ключ, защищенный парольной фразой, вам может быть предложено ввести парольную фразу при первом использовании ключа в каждом сеансе. Если вы впервые входите на сервер с паролем, вам также может быть предложено изменить пароль root.

О root
Пользователь root является администратором в среде Linux, который имеет очень широкие привилегии. Из-за повышенных привилегий учетной записи root вам не рекомендуется использовать ее на регулярной основе. Это связано с тем, что учетная запись root может вносить очень разрушительные изменения, даже случайно.

Следующим шагом является настройка новой учетной записи пользователя с ограниченными привилегиями для повседневного использования. Позже мы покажем вам, как временно получить повышенные привилегии на время, когда они вам понадобятся.

<h3 id="new_user">3.2 Создание нового пользователя</h3>
Как только вы войдете в систему как пользователь root, вы сможете добавить новую учетную запись пользователя. В будущем мы будем входить в систему с этой новой учетной записью вместо root.

В этом примере создается новый пользователь с именем sammy, но вы должны заменить его именем пользователя, которое вам нравится:

```
adduser sammy
```

Вам будет задано несколько вопросов, начиная с пароля учетной записи.

Введите надежный пароль и, при необходимости, заполните любую дополнительную информацию, если хотите. Это не требуется, и вы можете просто нажать ENTERв любом поле, которое хотите пропустить.

<h3 id="выдача-прав">3.3 Предоставление административных прав</h3>
Теперь у нас есть новая учетная запись пользователя с обычными правами учетной записи. Однако иногда нам может потребоваться выполнить административные задачи.

Чтобы избежать необходимости выходить из нашего обычного пользователя и снова входить в систему под учетной записью root, мы можем настроить то, что известно как привилегии суперпользователя или root для нашей обычной учетной записи. Это позволит нашему обычному пользователю запускать команды с правами администратора, помещая слово sudoперед командой.

Чтобы добавить эти привилегии нашему новому пользователю, нам нужно добавить пользователя в группу sudo. По умолчанию в Ubuntu 20.04 пользователям, входящим в группу sudo, разрешено использовать эту sudoкоманду.

От имени пользователя root выполните эту команду, чтобы добавить нового пользователя в группу sudo (замените выделенное имя пользователя вашим новым пользователем):

```
usermod -aG sudo sammy
```

Теперь, войдя в систему как обычный пользователь, вы можете вводить sudoкоманды before, чтобы запускать их с правами суперпользователя.

<h3 id="настройка-брандмауэра">3.4 Настройка базового брандмауэра</h3>

Серверы Ubuntu 20.04 могут использовать брандмауэр UFW, чтобы убедиться, что разрешены только подключения к определенным службам. Мы можем настроить базовый брандмауэр с помощью этого приложения.

Примечание: Если ваши серверы работают на DigitalOcean, вы можете дополнительно использовать облачные брандмауэры DigitalOcean вместо брандмауэра UFW. Мы рекомендуем использовать только один брандмауэр одновременно, чтобы избежать конфликтующих правил, которые могут быть сложными для отладки.

Приложения могут регистрировать свои профили в UFW после установки. Эти профили позволяют UFW управлять этими приложениями по имени. OpenSSH, служба, позволяющая нам теперь подключаться к нашему серверу, имеет профиль, зарегистрированный в UFW.

Вы можете увидеть это, набрав:

```
ufw app list
```

```
Output
Available applications:
  OpenSSH
```

Нам нужно убедиться, что брандмауэр разрешает SSH-соединения, чтобы мы могли снова войти в систему в следующий раз. Мы можем разрешить эти подключения, введя:

```
ufw allow OpenSSH
```

После этого мы можем включить брандмауэр, набрав:

```
ufw enable
```

Введите yи нажмитеENTER, чтобы продолжить. Вы можете видеть, что SSH-соединения по-прежнему разрешены, введя:

```
ufw status
```

```
Output
Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere
OpenSSH (v6)               ALLOW       Anywhere (v6)
```

Поскольку брандмауэр в настоящее время блокирует все соединения, кроме SSH, при установке и настройке дополнительных служб вам потребуется настроить параметры брандмауэра, чтобы разрешить трафик. Вы можете изучить некоторые общие операции UFW в нашем руководстве UFW Essentials.

<h3 id="включение-внешнего-доступа">3.5 Включение внешнего доступа для вашего обычного пользователя</h3>

Теперь, когда у нас есть обычный пользователь для ежедневного использования, нам нужно убедиться, что мы можем напрямую подключиться к учетной записи по SSH.

Примечание: До подтверждения того, что вы можете войти в систему и использовать ее sudoс новым пользователем, мы рекомендуем оставаться в системе с правами root. Таким образом, при возникновении проблем вы можете устранить неполадки и внести любые необходимые изменения от имени root. Если вы используете дроплет DigitalOcean и у вас возникли проблемы с вашим корневым SSH-соединением, вы можете восстановить доступ к дроплетам с помощью консоли восстановления.

Процесс настройки доступа по SSH для вашего нового пользователя зависит от того, использует ли учетная запись root вашего сервера пароль или ключи SSH для аутентификации.

Если учетная запись root использует аутентификацию по паролю
Если вы вошли в свою учетную запись root, используя пароль, то аутентификация по паролю включена для SSH. Вы можете подключиться по SSH к своей новой учетной записи пользователя, открыв новый сеанс терминала и используя SSH под своим новым именем пользователя:

```
ssh sammy@your_server_ip
```

После ввода пароля вашего обычного пользователя вы войдете в систему. Помните, что если вам нужно выполнить команду с правами администратора, введите sudoперед ней вот так:

```
sudo command_to_run
```

Вам будет предложено ввести ваш обычный пароль пользователя при первом использовании sudoкаждого сеанса (и периодически после этого).

Для повышения безопасности вашего сервера мы настоятельно рекомендуем настраивать SSH-ключи вместо аутентификации по паролю. Следуйте нашему руководству по настройке ключей SSH в Ubuntu 20.04, чтобы узнать, как настроить аутентификацию на основе ключей.

Если учетная запись root использует аутентификацию по ключу SSH
Если вы вошли в свою учетную запись root с помощью ключей SSH, то аутентификация по паролю для SSH отключена. Для успешного входа в систему вам нужно будет добавить копию вашего локального открытого ключа в файл нового пользователя~/.ssh/authorized_keys.

Поскольку ваш открытый ключ уже находится в файле корневой учетной ~/.ssh/authorized_keysзаписи на сервере, мы можем скопировать этот файл и структуру каталогов в нашу новую учетную запись пользователя в нашем существующем сеансе.

Самый простой способ скопировать файлы с правильным владельцем и разрешениями - с rsyncпомощью команды. Это скопирует каталог корневого.ssh пользователя, сохранит разрешения и изменит владельцев файлов, и все это в одной команде. Убедитесь, что выделенные части приведенной ниже команды соответствуют имени вашего обычного пользователя:

Примечание: rsyncКоманда обрабатывает источники и назначения, которые заканчиваются косой чертой, иначе, чем те, которые не имеют косой черты. При использовании rsyncниже убедитесь, что исходный каталог (~/.ssh) не содержит завершающей косой черты (убедитесь, что вы не используете~/.ssh/).

Если вы случайно добавите завершающую косую черту в команду, rsyncсодержимое каталога корневой учетной записи будет скопировано ~/.sshsudoв домашний каталог пользователя вместо копирования всей ~/.sshструктуры каталогов. Файлы будут находиться в неправильном месте, и SSH не сможет их найти и использовать.

```
rsync --archive --chown=sammy:sammy ~/.ssh /home/sammy
```

Теперь откройте новый сеанс терминала на своем локальном компьютере и используйте SSH с вашим новым именем пользователя:

```
ssh sammy@your_server_ip
```

Вы должны войти в новую учетную запись пользователя без использования пароля. Помните, что если вам нужно выполнить команду с правами администратора, введите sudoперед ней вот так:

```
sudo command_to_run
```

Вам будет предложено ввести ваш обычный пароль пользователя при первом использовании sudoкаждого сеанса (и периодически после этого).
